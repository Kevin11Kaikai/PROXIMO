# MVP Alpha 演示脚本详细说明

本文档详细解释每个演示脚本的功能和它们展示的内容。

---

## 1. demo_session_manager.py - SessionManager 演示

### 🎯 目的
演示 **SessionManager**（会话管理器）的核心功能，这是 MVP Alpha 中负责管理多轮对话上下文的模块。

### 📋 具体演示内容

#### 演示 1: 基本会话管理
**做了什么**：
- 创建一个用户会话（`demo_user_session_001`）
- 添加 4 轮对话（用户和机器人交替）
- 展示如何获取和查看会话上下文

**展示的功能**：
```python
SessionManager.append_turn(user_id, "user", "你好，我想了解一下心理健康评估。")
SessionManager.append_turn(user_id, "bot", "你好！我很乐意帮助你...")
context = SessionManager.get_context(user_id)  # 获取上下文
```

**输出示例**：
```
当前会话上下文（4 轮）:
  1. [user] 你好，我想了解一下心理健康评估。... (2025-11-06T17:38:33)
  2. [bot] 你好！我很乐意帮助你。我们可以从 GAD-7 焦虑量表开始。...
  3. [user] 好的，我需要回答一些问题吗？...
  4. [bot] 是的，我会问你 7 个关于焦虑的问题。...
```

#### 演示 2: 自动修剪功能
**做了什么**：
- 继续添加更多对话轮次（总共超过 6 轮）
- 展示系统如何自动修剪到最近 6 轮

**为什么重要**：
- 防止上下文过长，影响 LLM 性能
- 保持对话相关性（只保留最近的对话）

**展示的功能**：
- 自动修剪机制：当对话超过 6 轮时，自动删除最旧的对话
- 保留最近 6 轮，确保上下文不会无限增长

#### 演示 3: 多用户独立会话
**做了什么**：
- 创建第二个用户会话（`demo_user_session_002`）
- 展示两个用户的会话完全独立，互不干扰

**为什么重要**：
- 确保用户隐私和数据隔离
- 每个用户有自己独立的对话历史

**展示的功能**：
- 多用户支持：不同 `user_id` 的会话完全隔离
- 数据独立性：用户 1 的对话不会影响用户 2

#### 演示 4: 获取最近 N 轮对话
**做了什么**：
- 展示如何获取指定数量的最近对话轮次
- 例如：获取最近 3 轮对话

**展示的功能**：
```python
recent_3 = SessionManager.get_recent_turns(user_id, 3)
```

#### 演示 5: 清空会话
**做了什么**：
- 展示如何清空某个用户的会话
- 验证清空后上下文为空

**展示的功能**：
```python
SessionManager.clear_session(user_id)
```

### ✅ 验证的核心功能
- ✅ 多轮对话上下文存储
- ✅ 自动修剪到最近 6 轮
- ✅ 多用户独立会话
- ✅ 获取最近 N 轮对话
- ✅ 清空会话

---

## 2. demo_complete_pipeline.py - 完整对话管道演示

### 🎯 目的
演示 **MVP Alpha 的完整对话管道**，从用户输入到最终响应的完整流程。

### 📋 具体演示内容

#### 完整流程（每个场景都执行）
1. **Assessment（评估）** - 使用 PHQ-9/GAD-7 量表评估用户回答
2. **Routing（路由决策）** - 根据评估结果决定对话路由（low/medium/high）
3. **Policy Execution（策略执行）** - 执行相应的对话策略，生成响应
4. **Session Management（会话管理）** - 更新会话上下文
5. **Persistence（持久化）** - 保存评估结果到数据库

#### 场景 1: 低风险场景（Minimal Severity）
**测试数据**：
- PHQ-9 回答：`["0", "0", "1", "0", "1", "0", "1", "0", "0"]`
- 用户消息：`"我今天感觉还好，只是有点累。"`

**预期结果**：
- 严重度：`minimal`
- 总分：`3.0`
- 路由：`low`
- Rigid Score：`0.15`
- 策略：Low Policy（温度 0.9，灵活对话）

**展示的内容**：
```
📊 评估结果:
  严重度: minimal
  总分: 3.0
  风险级别: low

🔄 路由决策:
  路由: low
  Rigid Score: 0.15
  原因: low_risk

💬 策略执行结果:
  策略: low
  温度: 0.78
  响应: 听起来你今天的状态还算可以，只是感到有些疲惫...
```

#### 场景 2: 中等风险场景（Moderate Severity）
**测试数据**：
- PHQ-9 回答：`["1", "1", "2", "2", "1", "2", "1", "2", "0"]`
- 用户消息：`"我最近一直感到焦虑，睡眠也不好。"`

**预期结果**：
- 严重度：`moderate`
- 总分：`12.0`
- 路由：`medium`
- Rigid Score：`0.60`
- 策略：Medium Policy（温度 0.6，半结构化对话）

**展示的内容**：
- 中等风险的处理方式
- 半结构化的对话策略
- 可能建议加入同伴支持小组

#### 场景 3: 高风险场景（硬锁定 - 自杀意念）
**测试数据**：
- PHQ-9 回答：`["1", "1", "1", "1", "1", "1", "1", "1", "2"]`（Item 9 = 2）
- 用户消息：`"我觉得没有意义了。"`

**预期结果**：
- 严重度：`moderate`（但触发硬锁定）
- 总分：`10.0`
- 路由：`high`
- Rigid Score：`1.0`（最高）
- 策略：High Policy（固定安全脚本，**无自由对话**）

**展示的内容**：
```
⚠️  硬锁定已触发！

💬 策略执行结果:
  策略: high
  🔒 使用固定安全脚本（无自由对话）
  响应: I'm here to support you, and I want to make sure you're safe...
  
  🚨 安全横幅:
     If you are in immediate danger, call or text 988...
```

**为什么重要**：
- 这是 MVP Alpha 的**安全锁定机制**
- 当检测到自杀意念时，系统会：
  - 立即触发硬锁定（rigid_score = 1.0）
  - 使用**固定安全脚本**（不是 LLM 生成的）
  - 显示安全横幅（988 热线）
  - **禁止自由对话**（防止 LLM 生成不当响应）

### ✅ 验证的核心功能
- ✅ 完整的评估 → 路由 → 策略执行流程
- ✅ 三种风险级别的处理
- ✅ 安全锁定机制
- ✅ 会话上下文管理
- ✅ 结果持久化

---

## 3. demo_assessment_repo.py - AssessmentRepo 演示

### 🎯 目的
演示 **AssessmentRepo**（评估仓库）的持久化功能，展示如何保存和查询评估历史。

### 📋 具体演示内容

#### 演示 1: 保存评估结果
**做了什么**：
- 执行一个 PHQ-9 评估
- 将评估结果、路由决策、策略结果保存到 SQLite 数据库

**展示的功能**：
```python
await repo.save(
    user_id=user_id,
    assessment=assessment1,      # 评估结果
    decision=decision1,          # 路由决策
    result=policy_result1        # 策略执行结果
)
```

**保存的数据包括**：
- 用户 ID
- 时间戳
- 量表类型（phq9/gad7/pss10）
- 分数和严重度
- 路由和 Rigid Score
- 标志（flags，如自杀意念）
- 完整的 JSON 数据（用于调试和分析）

#### 演示 2: 查询历史记录
**做了什么**：
- 查询某个用户的所有评估历史
- 展示历史记录的详细信息

**展示的功能**：
```python
history = await repo.history(user_id, limit=10)
```

**输出示例**：
```
找到 1 条历史记录:
  记录 1:
    ID: 1
    时间: 2025-11-06T17:39:22.283572
    量表: phq9
    分数: 3.0
    严重度: minimal
    路由: low
```

#### 演示 3: 检查是否有先前评估
**做了什么**：
- 检查用户是否有之前的评估记录
- 用于决定是否使用默认量表（GAD-7）

**展示的功能**：
```python
has_prior = await repo.has_prior_assessment(user_id)
```

**为什么重要**：
- MVP Alpha 的 Wireframe 要求：首次接触默认使用 GAD-7
- 如果用户有历史记录，可以使用其他量表

#### 演示 4: 保存多个评估（同一用户）
**做了什么**：
- 为同一用户执行第二次评估
- 展示如何保存多个评估记录
- 验证历史记录数量增加

**展示的功能**：
- 同一用户可以有多条评估记录
- 每条记录都有独立的时间戳和 ID

#### 演示 5: 高风险评估（自杀意念标志）
**做了什么**：
- 执行一个高风险评估（PHQ-9 Item 9 = 2，触发自杀意念）
- 展示如何保存和查询包含自杀意念标志的记录

**展示的功能**：
```python
# 评估结果包含 flags
flags = assessment.get("flags", {})
# flags = {"suicidal_ideation": True, "suicidal_ideation_score": 2}

# 保存时会包含这些标志
await repo.save(...)

# 查询时可以筛选高风险记录
high_risk_records = [
    r for r in history_all 
    if r.get('flags', {}).get('suicidal_ideation')
]
```

**为什么重要**：
- 可以快速识别高风险用户
- 支持后续的风险分析和监控

### ✅ 验证的核心功能
- ✅ 保存评估结果到 SQLite
- ✅ 查询历史记录
- ✅ 检查是否有先前评估
- ✅ 自杀意念标志处理
- ✅ 多评估记录管理

### 📝 技术细节
- 使用**临时数据库**（演示结束后自动清理）
- 数据库表结构包含完整的评估、决策、结果 JSON
- 支持按用户 ID 和时间戳查询

---

## 4. demo_multi_turn_conversation.py - 多轮对话场景演示

### 🎯 目的
演示**完整的多轮对话流程**，展示 SessionManager、AssessmentRepo 和 ConversationEngine 如何协同工作。

### 📋 具体演示内容

#### 第 1 轮：初次接触（GAD-7 默认评估）
**做了什么**：
- 用户首次接触系统
- 执行 GAD-7 评估（MVP Alpha 的默认首次接触量表）
- 展示评估结果和路由决策
- 展示会话上下文的创建

**展示的功能**：
- Wireframe 默认行为：首次接触使用 GAD-7
- 会话上下文的初始化
- 评估结果的保存

**输出示例**：
```
📊 评估结果:
  量表: gad7
  严重度: mild
  总分: 5.0
  路由: low

📝 会话上下文（2 轮）:
  [user] 你好，我想了解一下我的焦虑情况。...
  [bot] 你好！我很乐意帮助你...
```

#### 第 2 轮：继续对话（使用会话上下文）
**做了什么**：
- 用户继续对话，执行 PHQ-9 评估
- 展示系统如何使用第 1 轮的会话上下文
- 展示上下文如何传递给策略执行

**展示的功能**：
- 会话上下文的传递
- 多轮对话的连续性
- 上下文在策略执行中的作用

**输出示例**：
```
📝 会话上下文（4 轮）:
  [注意] 上下文包含了第 1 轮和第 2 轮的对话
  [user] 你好，我想了解一下我的焦虑情况。...
  [bot] 你好！我很乐意帮助你...
  [user] 我还想做一个抑郁评估。...
  [bot] 好的，我来为你做一个 PHQ-9 评估...
```

#### 第 3 轮：再次对话（上下文自动修剪）
**做了什么**：
- 用户再次对话
- 展示系统如何自动修剪上下文到最近 6 轮
- 展示历史记录的累积

**展示的功能**：
- 自动修剪机制
- 历史记录的累积
- 多轮对话的完整流程

#### 检查评估历史记录
**做了什么**：
- 查询用户的所有评估历史
- 展示历史记录的详细信息

**展示的功能**：
- 历史记录的查询
- 多轮对话的记录保存
- 时间序列的评估历史

### ✅ 验证的核心功能
- ✅ SessionManager 管理多轮对话上下文
- ✅ AssessmentRepo 持久化所有评估记录
- ✅ ConversationEngine 在每轮中使用上下文
- ✅ 上下文自动修剪到最近 6 轮
- ✅ 历史记录完整保存

### 🔄 完整数据流
```
第 1 轮:
  用户输入 → Assessment → Routing → Policy → 保存 → 更新会话

第 2 轮:
  获取会话上下文 → 用户输入 → Assessment → Routing → Policy（使用上下文）→ 保存 → 更新会话

第 3 轮:
  获取会话上下文（已修剪）→ 用户输入 → Assessment → Routing → Policy（使用上下文）→ 保存 → 更新会话
```

---

## 5. demo_history_query.py - 历史查询功能演示

### 🎯 目的
演示如何**查询和操作评估历史记录**，展示历史查询的各种功能。

### 📋 具体演示内容

#### 准备测试数据
**做了什么**：
- 创建 4 条测试评估记录：
  1. 低风险（PHQ-9，minimal severity）
  2. 中等风险（PHQ-9，moderate severity）
  3. 高风险（PHQ-9，包含自杀意念标志）
  4. GAD-7 评估

**为什么重要**：
- 为后续查询演示提供数据
- 展示不同类型评估的保存

#### 演示 1: 查询所有历史记录
**做了什么**：
- 查询用户的所有历史记录（不限制数量）
- 展示每条记录的详细信息

**展示的功能**：
```python
history_all = await repo.history(user_id, limit=100)
```

**输出示例**：
```
用户 demo_user_history_001 的所有历史记录（4 条）:
  记录 1: ID=11, 时间=..., 量表=gad7, 分数=9.0, 严重度=mild
  记录 2: ID=10, 时间=..., 量表=phq9, 分数=10.0, 严重度=moderate
  记录 3: ID=9, 时间=..., 量表=phq9, 分数=12.0, 严重度=moderate
  记录 4: ID=8, 时间=..., 量表=phq9, 分数=3.0, 严重度=minimal
```

#### 演示 2: 限制返回数量（最近 2 条）
**做了什么**：
- 查询最近 2 条记录
- 展示如何限制返回数量

**展示的功能**：
```python
history_recent = await repo.history(user_id, limit=2)
```

**为什么重要**：
- 在实际应用中，通常只需要最近的记录
- 减少数据传输和处理时间

#### 演示 3: 查看包含自杀意念标志的记录
**做了什么**：
- 筛选出包含自杀意念标志的记录
- 展示高风险记录的详细信息

**展示的功能**：
```python
high_risk_records = [
    r for r in history_all 
    if r.get('flags', {}).get('suicidal_ideation')
]
```

**输出示例**：
```
找到 1 条高风险记录（包含自杀意念标志）:
  记录 1:
    时间: 2025-11-06T17:39:48.635951
    量表: phq9
    分数: 10.0
    严重度: moderate
    自杀意念: True
    自杀意念分数: 2
```

**为什么重要**：
- 快速识别高风险用户
- 支持风险监控和预警

#### 演示 4: 查看完整评估详情（JSON）
**做了什么**：
- 展示如何访问完整的评估详情（JSON 格式）
- 包括评估结果、路由决策、策略结果

**展示的功能**：
- `assessment_json`: 完整的评估结果
- `decision_json`: 路由决策详情
- `result_json`: 策略执行结果
- `preview_text`: 响应预览（前 200 字符）

**为什么重要**：
- 支持详细的数据分析
- 用于调试和审计

#### 演示 5: 查询不同用户的历史
**做了什么**：
- 创建第二个用户
- 展示不同用户的历史记录完全独立

**展示的功能**：
- 多用户数据隔离
- 每个用户有独立的历史记录

**输出示例**：
```
用户 demo_user_history_001 的记录数: 4
用户 demo_user_history_002 的记录数: 1
不同用户的历史记录完全独立
```

### ✅ 验证的核心功能
- ✅ 按用户 ID 查询历史
- ✅ 限制返回数量
- ✅ 查看自杀意念标志
- ✅ 查看完整评估详情
- ✅ 多用户数据隔离

---

## 📊 总结对比

| 演示脚本 | 主要功能 | 核心模块 | 关键展示 |
|---------|---------|---------|---------|
| `demo_session_manager.py` | 会话管理 | SessionManager | 多轮对话上下文、自动修剪、多用户隔离 |
| `demo_complete_pipeline.py` | 完整流程 | ConversationEngine | 评估→路由→策略、三种风险场景、安全锁定 |
| `demo_assessment_repo.py` | 持久化 | AssessmentRepo | 保存评估、查询历史、标志处理 |
| `demo_multi_turn_conversation.py` | 多轮对话 | 全部模块 | 完整多轮流程、上下文传递、历史累积 |
| `demo_history_query.py` | 历史查询 | AssessmentRepo | 查询历史、筛选高风险、多用户隔离 |

---

## 🎯 这些演示的价值

### 1. **功能验证**
- 验证 MVP Alpha 的核心功能是否正常工作
- 确保各个模块正确集成

### 2. **学习工具**
- 帮助新开发者理解系统架构
- 展示每个模块的使用方法

### 3. **演示工具**
- 可以向利益相关者展示系统功能
- 可视化 MVP Alpha 的能力

### 4. **调试工具**
- 可以快速定位问题
- 验证修复是否有效

---

## 🚀 运行建议

### 推荐运行顺序
1. **先运行** `demo_session_manager.py` - 了解基础概念
2. **然后运行** `demo_assessment_repo.py` - 了解持久化
3. **接着运行** `demo_complete_pipeline.py` - 了解完整流程
4. **最后运行** `demo_multi_turn_conversation.py` 和 `demo_history_query.py` - 了解高级功能

### 或者
直接运行 `run_all_demos.py` 一次性查看所有演示！

---

**创建日期**: 2025-11-06  
**维护者**: 开发团队

